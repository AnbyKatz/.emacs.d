PROGRAM QMC_1996_CodeV1
  USE usefulFunctions
  USE Kinds
  USE Pyplots
  IMPLICIT NONE

  INTEGER ,PARAMETER     :: N = 1000
  INTEGER                :: ii,ID,guess,counter
  REAL(DP),DIMENSION(N)  :: x_ax,y_ax
  REAL(DP),DIMENSION(N,6):: data1,data2,data3

  REAL(DP),DIMENSION(3)  :: coupling,BagRadii
  REAL(DP)         :: x,Omega0,dOmega0, &
       Mq,Mn,fmMeV,Bag,z0,SIGfield,&
       Msigma,Rho0,RhoB,Sc_G,RB,&
       sigma,a,b,absErr,relErr,d

  !---------------------------------------------------------------------!
  !                                                                     !
  !                           Parameters Below                          !
  !                                                                     !
  !---------------------------------------------------------------------!

  coupling(1) = SQRT(5.86*4*pi)           !constant
  coupling(2) = SQRT(5.40*4*pi)           !constant
  coupling(3) = SQRT(5.07*4*pi)           !constant
  BagRadii(1) = 0.6                       !fm
  BagRadii(2) = 0.8                       !fm
  BagRadii(3) = 1.0                       !fm
  counter = 1                             

  ! Conversion Factors
  fmMeV = 1/(197.327)                     !for fm -> MeV^{-1}

  ! Set model parameters
  Mq = 5                                  !MeV
  Mn = 939                                !MeV
  Rho0 = 0.16_dp                          !fm^{-3}
  Msigma = 550                            !MeV
  x_ax = linspace(0.001_dp,Rho0*2.5,N)    !fm^{-3}
  
  !---------------------------------------------------------------------!
  !                                                                     !
  !                              Code Below                             !
  !                                                                     !
  !---------------------------------------------------------------------!

  OPEN(100,file="1996_Results.dat",action="write", &
       & status="replace",form="formatted")

  DO ii = 2,6,2    
     Sc_G = coupling(counter)
     RB   = BagRadii(counter)
     CALL calculate_Bzd(RB,Mq,Bag,z0,d)
     WRITE(100,'(f12.4,f12.4)') Bag**(1/4.0),z0
     CALL gsigmaVSrhob(Sc_G,RB,data1(:,ii))  
     data1(:,ii) = data1(:,ii)*Sc_G
     CALL Meff_C(data1(:,ii),data2(:,ii),data3(:,ii))
     counter = counter+1
  END DO

  x_ax = x_ax/Rho0

  DO ii = 1,6,2
     data1(:,ii) = x_ax                    !data1 = (g_σ)σ VS ρ/ρ₀
     data2(:,ii) = x_ax                    !data2 = Mₙ* VS ρ/ρ₀
     data3(:,ii) = data1(:,ii+1)           !data3 = C VS (g_σ)σ
  END DO

  CALL plot(data1,"ρ/ρ₀","(g_σ)σ (MeV)")
  CALL plot(data2,"ρ/ρ₀","Mₙ* (MeV)")
  CALL plot(data3,"(g_σ)σ (MeV)","C")

  CLOSE(100)



CONTAINS

  !---------------------------------------------------------------------!
  !                                                                     !
  !                    Calculates Bag constant and z0                   !
  !                                                                     !
  !---------------------------------------------------------------------!


  SUBROUTINE calculate_Bzd(RB,Mq,Bag,z0,d)
    USE usefulFunctions
    USE Kinds
    IMPLICIT NONE
    REAL(DP), INTENT(in) :: RB,Mq
    REAL(DP), INTENT(out):: Bag,z0,d

    INTEGER , PARAMETER        :: N = 10000, delta = 10
    INTEGER,  DIMENSION(1)     :: loc
    INTEGER                    :: intersect
    REAL(DP), DIMENSION(N)     :: xvals_1,yvals_1,yvals_2,beta
    REAL(DP), DIMENSION(delta) :: xmin_array
    REAL(DP)                   :: st,ed,radius

    radius = RB*fmMeV

    st = 0.01
    ed = 6.0
    xvals_1 = linspace(st,ed,N)  
    yvals_1 = SIN(xvals_1)/xvals_1
    beta = SQRT( ( SQRT( xvals_1**2+(Mq*radius)**2 ) - Mq*radius ) &
         /( SQRT( xvals_1**2+(Mq*radius)**2 ) + Mq*radius ) )
    yvals_2 = beta*(SIN(xvals_1)/(xvals_1**2)-COS(xvals_1)/xvals_1)

    intersect = GuessZero(yvals_1-yvals_2)

    xmin_array = yvals_1(intersect-delta:intersect) &
         - yvals_2(intersect-delta:intersect)

    loc = MINLOC(xmin_array)
    x = xvals_1(intersect-(delta-loc(1)))

    Omega0 = SQRT( x**2 + (Mq*radius)**2 )  
    dOmega0 = (2*(Mq**2)*radius)/Omega0

    Bag = (3.0/(16.0*pi*(radius**3)))*(MN - 3.0*dOmega0 )
    z0 = 3.0*Omega0 - MN*radius +Bag*(4.0/3.0)*pi*(radius**4)

    d = 0.22*RB         !fm
    d = d*fmMeV         !MeV^{-1}

  END SUBROUTINE calculate_Bzd

  !---------------------------------------------------------------------!
  !                                                                     !
  !                        Function to Integrate                        !
  !                                                                     !
  !---------------------------------------------------------------------!

  FUNCTION f(x)
    USE Kinds
    IMPLICIT NONE

    REAL(DP), INTENT(in)  :: x
    REAL(DP)              :: f

    REAL(DP)              :: C,Meff

    C = 1-d*Sc_G*sigma
    Meff = MN - (1-(d/2)*Sc_G*sigma)*Sc_G*sigma

    f = (Meff*(x**2))/(SQRT( Meff**2 + x**2 ))

  END FUNCTION f

  !---------------------------------------------------------------------!
  !                                                                     !
  !                   Solve of zero's of this Function                  !
  !                                                                     !
  !---------------------------------------------------------------------!

  FUNCTION g(x)
    USE Kinds
    IMPLICIT NONE

    REAL(DP), INTENT(in)  :: x
    REAL(DP)              :: g

    sigma = x
    g = (((Sc_G/Msigma**2)*(1-d*Sc_G*x)*(2/pi**2))&
         *integral(f,a,b,absErr,relErr))-x

  END FUNCTION g


  !---------------------------------------------------------------------!
  !                                                                     !
  !                Returns y-values of scalar meson field               !
  !                                                                     !
  !---------------------------------------------------------------------!


  SUBROUTINE gsigmaVSrhob(Sc_G,RB,yvals)
    USE Kinds
    IMPLICIT NONE

    REAL(DP),INTENT(in)               :: Sc_G,RB
    REAL(DP),DIMENSION(N),INTENT(out) :: yvals

    REAL(DP),DIMENSION(N)             :: xx,yy
    INTEGER                           :: jj,kk

    xx = linspace(0.001_dp,500/Sc_G,N)      !MeV
    absErr = 1e-6
    relErr = 1e-6
    a = 0

    DO jj = 1,N

       RhoB = x_ax(jj)*(fmMeV**(-3))        !MeV^{3}
       b =(3*(pi**2)*RhoB/2)**(1/3.0)       !MeV

       DO kk = 1,N
          sigma = xx(kk)
          yy(kk) = (((Sc_G/Msigma**2)*(1-d*Sc_G*sigma)*(2/pi**2))&
               *integral(f,a,b,absErr,relErr))-sigma
       END DO

       guess = GuessZero(yy)
       yvals(jj) = newton1D(g,xx(guess))

    END DO

  END SUBROUTINE gsigmaVSrhob


  !---------------------------------------------------------------------!
  !                                                                     !
  !                      Effective Mass Calculation                     !
  !                                                                     !
  !---------------------------------------------------------------------!


  SUBROUTINE Meff_C(xvals,Meff,C)
    USE Kinds
    IMPLICIT NONE

    REAL(DP),DIMENSION(:),INTENT(in)  :: xvals
    REAL(DP),DIMENSION(:),INTENT(out) :: Meff,C

    REAL(DP) :: tst

    Meff = MN - (1-(d/2)*xvals)*xvals
    C    = 1 - d*xvals

  END SUBROUTINE Meff_C

END PROGRAM QMC_1996_CodeV1
